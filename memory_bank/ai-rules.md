# ShuangxiangApp AI 工程规则（最终定稿 v1.1）

> 目标：强制 **模块化（多文件）**，严禁 **单体巨文��（monolith）**；严格 **MVP 优先**；严格 **依赖完整复用成熟生产级库**（禁止复制/裁剪/重写/替代）；所有步骤 **小而具体** 且 **每步必须有测试**；所有结论必须 **可验证、可审计、可复现**。

---

## 0) 规则等级与优先级（Always）

### 0.1 规则等级
- **Always**：硬规则。不满足必须停止实现，先修复。
- **Guideline**：默认遵循。若偏离必须说明原因、影响、替代方案、回归测试。

### 0.2 冲突处理优先级（从高到低）
1. 合规 / 隐私 / 安全
2. Always：必读、里程碑更新、反 monolith、每步测试、CI 门禁
3. 依赖完整复用与完整性审计（��款 1–40）
4. 技术栈最佳实践（Flutter / NestJS / FastAPI / PG / Redis / BullMQ / WS / OTel）
5. 风格与偏好

### 0.3 “模块化”与“不得二次抽象依赖”的统一口径（Always）
- 允许并强制 **按业务域拆模块**、按用例拆流程，确保多文件、可测、可维护。
- 禁止把成熟依赖库再包成“自研通用层/框架层”（网络层、埋点 SDK、队列框架、状态框架等）。
- **允许拆分的内容仅限：业务流程编排、模块组合调度、参数配置、输入输出适配。**
- **禁止：复制依赖源码、裁剪、重写、降级封装、替代实现、伪集成。**

---

## A) 开工必读与里程碑更���（Always）

### A1. 写任何代码前必须完整阅读（Always）
写任何代码前必须完整阅读：
- `memory-bank/@architecture.md`（包含完整数据库结构）
- `memory-bank/@game-design-document.md`

并在开始实现前明确确认：
- DB 是否覆盖：课堂会话、事件埋点明细、反馈、知识点、推荐、评分/督导
- 事件契约是否覆盖并符合验收口径
- 权限边界是否明确：教师仅本班，学生仅个人+班级聚合

若上述文件缺失/空/不一致：必须先要求补齐或更新，禁止先写代码。

### A2. 每完成重大功能或里程碑后必须更新架构（Always）
每完成一个重大功能或里程碑后，必须更新 `memory-bank/@architecture.md`，至少包含：
- 模块边界（Flutter / NestJS / FastAPI / PG / Redis / WS / BullMQ / S3 / OTel）
- 数据结构变更（表/索引/分区/保留与清理）
- 事件与 WS/API 契约（字段、版本、兼容策略）
- 异步任务清单（BullMQ：幂等键、重试、死信、可观测）
- 合规策略（最小化采集、匿名化、保留周期）
- 可观测性字段规范（trace/correlation、日志字段、指标）

重大功能/里程碑包含但不限于：
- 新业务域上线：内容/课堂/监测/反馈/推荐/评分督导
- 引入或变更：WS、BullMQ、Redis 聚合、核心表/事件字段、权限边界、报表口径、AI 服务契约

---

## B) 反 monolith：强制模块化与硬阈值（Always）

### B1. 单文件行数硬阈值（Always）
任一业务源码文件 **> 250 行** 必须拆分，否则禁止继续。

### B2. 单业务域目录文件数硬阈值（Always）
单业务域目录 **同一层级**文件数不得超过：
- Flutter（Dart）：25
- NestJS（TypeScript）：25
- FastAPI（Python）：20

触发阈值必须立刻二级拆分，否则禁止继续新增功能。

### B3. 职责混杂与跨域耦合禁止（Always）
禁止单文件/单模块同时承担 2+ 层职责：
- UI、状态管理、业务规则、网络、存储、埋点、报表聚合、推荐算法

禁止单文件/单模块跨 2+ 业务域：
- 内容管理、课堂会话、专注监测、反馈闭环、推荐、评分督导

跨域交互必须通过：
- 明确的契约层（contracts）与域边界接口
禁止绕过契约层直接 import 对方内部实现。

### B4. 拆分方式（Always）
触发阈值或职责混杂时，按顺序拆分：
1) 按子能力二级目录拆分
2) 本域 contract 子目录集中声明（仅契约/字段/版本，不含逻辑）
3) usecase 子目录承载流程编排（每个用例对应最小流程）
4) infra-adapter 按依赖类型分（network/ws/db/queue/telemetry/storage），仅做 IO 适配，不得二次抽象成熟库能力

### B5. 结构验证（Always）
每一步必须通过：
- 文件行数审计
- 目录文件数审计
- 跨域依赖边界审计
- 每个业务域测试可独立运行

---

## C) 小步交付与测试（Always）

### C1. 每一步必须小而具体（Always）
每一步必须包含：
1) 目标（可验收）
2) 改动范围（模块/文件/边界）
3) 风险点（合规/误判/性能/一致性）
4) **测试**（自动化优先；否则提供可复现手测脚本+预期结果）
5) 回滚策略

### C2. 每一步必须有测试（Always）
不允许“后面再补测试”。
涉及到的边界条件必须测：
- 断网/弱网：离线→补传→幂等
- 杀后台：退出判定（后续迭代）
- 并发：100 人/课堂（在对应里程碑必须完成验证）

---

## D) 合规与 MVP 范围（Always）

### D1. 默认温和监管（Always）
默认策略：最小化采集 + 端侧判定 + 统计报表 + 教师确认。
MVP 禁止：
- 摄像头监控
- MDM 强制管控
- 自动惩戒扣分

### D2. 数据保留策略（Always）
必须在架构中明确并可验证：
- 行为数据：30
